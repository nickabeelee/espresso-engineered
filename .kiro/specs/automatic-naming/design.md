# Automatic Naming Feature Design

## Overview

The automatic naming feature eliminates manual naming effort for baristas by generating consistent, descriptive names for bags and brews based on contextual information. This feature integrates seamlessly with the existing brew logging system, reducing friction during the brewing moment while maintaining clear identification of brewing records and inventory items.

The system generates names using predefined templates:
- **Bags**: "{owner's display_name}'s {bean_name} {roast_date}"
- **Brews**: "{barista's display_name} {bean_name} {local_time_to_minute}"

The naming system operates transparently, requiring no user input while providing clear visibility of the generated names in the UI.

## Architecture

### System Integration

The automatic naming feature integrates with the existing three-layer architecture:

```
SvelteKit Frontend (Netlify)
    ↓ Displays generated names, no input required
Fastify Backend (Fly.io)
    ↓ Naming service generates names before database insertion
Supabase Database (PostgreSQL + Auth)
    ↓ Stores generated names in bag.name and brew.name fields
```

### Naming Service Architecture

```
Frontend Form Submission
    ↓
Backend API Endpoint
    ↓
Naming Service (generates name)
    ↓ Queries for related data
Database (barista, bean, bag tables)
    ↓ Returns contextual data
Naming Service (applies template)
    ↓ Generated name
Database Insertion (with name)
```

### Data Flow

1. **Bag Creation**: User submits bag form → Backend queries bean and barista data → Naming service generates name → Database stores bag with generated name
2. **Brew Creation**: User submits brew form → Backend queries bag, bean, and barista data → Naming service generates name → Database stores brew with generated name
3. **Frontend Display**: Generated names are displayed in forms and lists without editable input fields

## Components and Interfaces

### Backend Components

#### NamingService Class
```typescript
class NamingService {
  generateBagName(ownerId: string, beanId: string, roastDate?: string): Promise<string>
  generateBrewName(baristaId: string, bagId: string, createdAt: Date): Promise<string>
  private getBaristaDisplayName(baristaId: string): Promise<string>
  private getBeanName(beanId: string): Promise<string>
  private formatRoastDate(roastDate?: string): string
  private formatBrewTime(createdAt: Date): string
}
```

**Key Methods:**
- `generateBagName()`: Creates bag names using owner, bean, and roast date
- `generateBrewName()`: Creates brew names using barista, bean, and creation time
- `getBaristaDisplayName()`: Retrieves display_name with first_name fallback
- `getBeanName()`: Retrieves bean name from bean table
- `formatRoastDate()`: Formats roast dates as "YYYY-MM-DD" or "Unknown Roast"
- `formatBrewTime()`: Formats creation time as "HH:MM" in local timezone

#### API Integration Points

**Bag Creation Endpoint Enhancement**
```typescript
// POST /api/bags
async function createBag(bagData: CreateBagRequest): Promise<Bag> {
  const generatedName = await namingService.generateBagName(
    bagData.owner_id,
    bagData.bean_id,
    bagData.roast_date
  );
  
  const bagWithName = { ...bagData, name: generatedName };
  return await bagRepository.create(bagWithName);
}
```

**Brew Creation Endpoint Enhancement**
```typescript
// POST /api/brews
async function createBrew(brewData: CreateBrewRequest): Promise<Brew> {
  const generatedName = await namingService.generateBrewName(
    brewData.barista_id,
    brewData.bag_id,
    new Date()
  );
  
  const brewWithName = { ...brewData, name: generatedName };
  return await brewRepository.create(brewWithName);
}
```

### Frontend Components

#### Enhanced Form Components

**BagForm Component Updates**
```typescript
// Remove name input field, display generated name preview
interface BagFormProps {
  onSubmit: (bagData: CreateBagData) => void;
  previewMode?: boolean;
}

// Component shows generated name preview without input field
// Clear visual indication that naming is automatic
```

**BrewForm Component Updates**
```typescript
// Remove name input field, display generated name preview
interface BrewFormProps {
  brewId?: string;
  prefillFromLast?: boolean;
  onSubmit: (brewData: CreateBrewData) => void;
}

// Component shows generated name preview without input field
// Updates preview as user selects different bags/beans
```

#### Name Display Components

**AutoGeneratedNameDisplay Component**
```typescript
interface AutoGeneratedNameDisplayProps {
  name: string;
  type: 'bag' | 'brew';
  isPreview?: boolean;
}

// Displays generated names with clear visual indication
// Shows "Auto-generated" label or icon
// Different styling for preview vs final names
```

### Data Models

#### Enhanced TypeScript Interfaces

```typescript
interface BagWithAutoName extends Bag {
  name: string; // Always populated by naming service
  auto_generated_name: boolean; // Indicates automatic generation
}

interface BrewWithAutoName extends Brew {
  name: string; // Always populated by naming service
  auto_generated_name: boolean; // Indicates automatic generation
}

interface NamingContext {
  baristaDisplayName: string;
  baristaFirstName?: string;
  beanName: string;
  roastDate?: string;
  createdAt: Date;
  timezone?: string;
}
```

#### Database Schema Considerations

The existing `bag.name` and `brew.name` fields will be used to store generated names. No schema changes are required, but the fields will transition from optional user input to required auto-generated values.

## Error Handling

### Naming Service Error Handling

**Data Retrieval Failures**
- **Missing Barista**: Use "Anonymous" fallback
- **Missing Bean**: Use "Unknown Bean" fallback
- **Database Connection Issues**: Log error, use fallback values, continue operation

**Name Generation Failures**
- **Template Processing Errors**: Log detailed error, set name to null
- **Concurrent Creation Conflicts**: Handle gracefully with unique identifiers if needed
- **Performance Timeouts**: Log warning, use simplified naming pattern

### Frontend Error Handling

**Name Preview Failures**
- **API Errors**: Show "Name will be generated" placeholder
- **Network Issues**: Display offline indicator, queue for sync
- **Validation Errors**: Show clear error messages with retry options

### Backend Error Handling

**API Integration Errors**
- **Naming Service Failures**: Log error, continue with null name, return success
- **Database Constraint Violations**: Handle gracefully, retry with modified name if needed
- **Performance Issues**: Implement caching and optimization strategies

## Testing Strategy

The testing approach combines unit tests for specific naming logic with property-based tests for universal correctness properties across all naming scenarios.

### Unit Testing

**Backend Unit Tests**
- **NamingService Methods**: Test each naming method with various input combinations
- **Template Processing**: Test name generation with different data scenarios
- **Fallback Logic**: Test edge cases with missing or invalid data
- **API Integration**: Test endpoint integration with naming service

**Frontend Unit Tests**
- **Component Rendering**: Test form components display generated names correctly
- **Preview Functionality**: Test name preview updates with form changes
- **Error States**: Test component behavior when naming fails
- **Visual Indicators**: Test auto-generation indicators display properly

### Property-Based Testing Framework

The system will use **fast-check** for JavaScript/TypeScript property-based testing, configured to run a minimum of 100 iterations per property test.

Each property-based test will be tagged with comments explicitly referencing the correctness property from this design document using the format: `**Feature: automatic-naming, Property {number}: {property_text}**`

### Integration Testing

**End-to-End Naming Workflows**
- **Complete Bag Creation**: Test full workflow from form submission to database storage
- **Complete Brew Creation**: Test full workflow including name preview and final generation
- **Cross-Component Integration**: Test naming consistency across different UI components

**Performance Testing**
- **Concurrent Creation**: Test naming service under concurrent load
- **Database Performance**: Test naming queries don't impact overall system performance
- **Caching Effectiveness**: Test caching improves naming service performance

### Test Data Management

**Naming Test Fixtures**
- **Barista Profiles**: Test data with various display_name and first_name combinations
- **Bean Data**: Test data with various bean names and edge cases
- **Date Scenarios**: Test data covering different roast dates and timezone scenarios

**Mock Services**
- **Database Mocking**: Mock database responses for isolated naming service testing
- **Time Mocking**: Mock system time for consistent brew time formatting tests
- **Timezone Mocking**: Mock timezone data for timezone-specific testing


## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system-essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*

### Property 1: Template Format Consistency
*For any* bag or brew creation with valid barista, bean, and temporal data, the generated name should match the expected template format: "{display_name}'s {bean_name} {roast_date}" for bags and "{display_name} {bean_name} {HH:MM}" for brews
**Validates: Requirements 1.1, 2.1**

### Property 2: Date Formatting Consistency
*For any* bag with a valid roast_date, the date portion of the generated name should be formatted as "YYYY-MM-DD"
**Validates: Requirements 1.2**

### Property 3: Time Formatting Consistency
*For any* brew creation timestamp, the time portion of the generated name should be formatted as "HH:MM" in 24-hour format
**Validates: Requirements 2.2**

### Property 4: Special Character Preservation
*For any* barista display_name or bean name containing special characters, those characters should be preserved exactly in the generated bag and brew names
**Validates: Requirements 1.4, 2.4**

### Property 5: Name Persistence
*For any* bag or brew creation, the generated name should be automatically set in the respective name field and persisted to the database
**Validates: Requirements 1.5, 2.5**

### Property 6: Bean Name Extraction
*For any* brew referencing a bag, the bean_name in the generated brew name should match the bean name from the bag's associated bean record
**Validates: Requirements 2.3**

### Property 7: Database Failure Resilience
*For any* name generation attempt where database queries for related entities fail, the system should use appropriate fallback values and continue name generation without throwing errors
**Validates: Requirements 3.4**

### Property 8: Concurrent Creation Safety
*For any* set of concurrent bag and brew creation requests, the naming system should generate unique, conflict-free names for all entities
**Validates: Requirements 3.6**

### Property 9: API Name Generation Timing
*For any* bag or brew created via API endpoint, the automatic name should be generated and present in the entity data before database insertion occurs
**Validates: Requirements 4.1, 4.3**

### Property 10: Frontend Name Display
*For any* bag or brew created via frontend form, the automatic name should be generated and displayed immediately when sufficient form data is available
**Validates: Requirements 4.2, 4.4**

### Property 11: Preview-Storage Consistency
*For any* bag or brew creation, the name shown in the frontend preview should exactly match the name stored in the database after creation
**Validates: Requirements 4.5**

### Property 12: Admin Override Capability
*For any* automatically generated name, administrators should be able to successfully override the name with a custom value
**Validates: Requirements 5.3**

### Property 13: Timezone-Aware Time Formatting
*For any* brew creation with barista timezone information, the time portion of the generated name should reflect the barista's local timezone
**Validates: Requirements 6.1**

### Property 14: Cross-Environment Time Consistency
*For any* brew creation, the time formatting in the generated name should be consistent regardless of the barista's device or browser settings
**Validates: Requirements 6.4**

### Property 15: Timezone Context Preservation
*For any* brew creation, the timezone context should be preserved throughout the naming process to ensure accurate time representation
**Validates: Requirements 6.5**

### Property 16: UI Display Without Input
*For any* bag or brew form in the UI, the automatically generated name should be displayed without providing an editable name input field
**Validates: Requirements 8.1, 8.2**

### Property 17: Auto-Generation Visual Indication
*For any* displayed automatic name in the UI, there should be clear visual indication that the name was automatically generated
**Validates: Requirements 8.3**

### Property 18: Name Preview Functionality
*For any* bag or brew form, a preview of the generated name should be shown and should update correctly as form data changes
**Validates: Requirements 8.4**

### Property 19: Creation Confirmation Display
*For any* completed bag or brew creation, the success message or display should include the final generated name
**Validates: Requirements 8.5**